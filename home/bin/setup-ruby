#!/bin/bash -ex
ensure_gems_installed() {
  gems=''

  for gem in $@; do
    `gem list -i $gem` || gems="$gems $gem"
  done

  if [[ -n $gems ]]; then
    gem install $gems
  fi
}

if which lsb_release &> /dev/null && lsb_release -i | grep -qi Ubuntu; then
  sudo apt-get install -y \
    build-essential zlib1g-dev \
    libssl-dev openssl \
    libreadline-dev \
    sqlite3 libsqlite3-dev \
    libxslt-dev libxml2-dev \
    curl wget git-core
fi

RBENV_ROOT=~/.rbenv

[[ -d $RBENV_ROOT ]] || git clone https://github.com/sstephenson/rbenv.git $RBENV_ROOT
mkdir -p $RBENV_ROOT/{plugins,cache}
[[ -d $RBENV_ROOT/plugins/ruby-build ]] || git clone https://github.com/sstephenson/ruby-build.git $RBENV_ROOT/plugins/ruby-build
[[ -d $RBENV_ROOT/plugins/rbenv-gemset ]] || git clone https://github.com/jamis/rbenv-gemset.git $RBENV_ROOT/plugins/rbenv-gemset

LATEST_VERSION=1.9.3-p327
LATEST_PATCH_GIST=1688857

BUILDFILE=$RBENV_ROOT/plugins/ruby-build/share/ruby-build/$LATEST_VERSION-perf

[[ -e $BUILDFILE ]] || (curl https://raw.github.com/gist/$LATEST_PATCH_GIST/2-$LATEST_VERSION-patched.sh > $BUILDFILE )
[[ -e $RBENV_ROOT/versions/$LATEST_VERSION-perf/bin/ruby ]] || ( rbenv install --keep $LATEST_VERSION-perf && rbenv global $LATEST_VERSION-perf )

ensure_gems_installed bundler pry pry-doc pry-nav pry-stack_explorer
